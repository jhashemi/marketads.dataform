# Multi-Table Waterfall Strategy Testing Guide

This document outlines the approach for testing the Multi-Table Waterfall matching strategy in the MarketAds Dataform project.

## Overview

The Multi-Table Waterfall strategy is a complex matching strategy that prioritizes matches based on reference table priority and match confidence. It supports multiple reference tables, each with its own priority, matching rules, field mappings, required fields, and confidence multipliers.

## Test Components

The integration tests for the Multi-Table Waterfall strategy are located in `tests/integration/multi_table_waterfall_tests.js`. They validate the following components:

1. **Basic Multi-Table Waterfall Test** (`multi_table_waterfall_basic_test`): Validates the core functionality of the strategy, including:
   - SQL generation for multiple reference tables
   - Proper prioritization of matches
   - Correct scoring calculations

2. **Field Mapping Test** (`multi_table_waterfall_field_mapping_test`): Validates that the strategy correctly handles field mappings between different tables.

3. **Confidence Test** (`multi_table_waterfall_confidence_test`): Validates that the strategy applies confidence multipliers per reference table.

4. **Required Fields Test** (`multi_table_waterfall_required_fields_test`): Validates that the strategy correctly enforces required fields for matches.

5. **Large Scale Test** (`multi_table_waterfall_large_scale_test`): Combines all the above features to validate that they work together.

## Implementation Details

### Factory Pattern

The `MatchStrategyFactory` class is used to create instances of the `MultiTableWaterfallStrategy` class. This allows for consistent instantiation and configuration of the strategy.

```javascript
// Import as a class
const { MatchStrategyFactory } = require('../../includes/match_strategy_factory');

// Create an instance
const matchStrategyFactory = new MatchStrategyFactory();

// Create strategy with options
const strategy = matchStrategyFactory.createMultiTableWaterfallStrategy({
  referenceTables: parameters.referenceTables,
  matchingRules: parameters.matchingRules,
  thresholds: parameters.thresholds,
  // Additional options as needed
  fieldMappings: parameters.fieldMappings,
  requiredFields: parameters.requiredFields,
  confidenceMultipliers: parameters.confidenceMultipliers
});
```

### Field Mappings

Field mappings should be provided as an object with reference table IDs as keys and arrays of mapping objects as values:

```javascript
fieldMappings: {
  'verified_customers': [
    { sourceField: 'first_name', targetField: 'first_name_mapped' },
    { sourceField: 'last_name', targetField: 'last_name_mapped' },
    { sourceField: 'email', targetField: 'email_mapped' }
  ],
  'crm_customers': [
    { sourceField: 'fname', targetField: 'first_name_mapped' },
    { sourceField: 'lname', targetField: 'last_name_mapped' },
    { sourceField: 'phone_number', targetField: 'phone_mapped' }
  ]
}
```

### Required Fields

Required fields should be provided as an object with reference table IDs as keys and arrays of field names as values:

```javascript
requiredFields: {
  'verified_customers': ['email'],
  'crm_customers': ['phone']
}
```

### Confidence Multipliers

Confidence multipliers should be provided as an object with reference table IDs as keys and numeric multiplier values as values:

```javascript
confidenceMultipliers: {
  'verified_customers': 1.2,
  'crm_customers': 0.9
}
```

## Testing Approach

The tests validate the SQL generated by the strategy, checking for specific patterns that indicate correct implementation:

1. **Reference Tables**: SQL should include JOINs for all reference tables
2. **Prioritization**: SQL should include ORDER BY clauses for proper prioritization
3. **Scoring**: SQL should include match score calculations
4. **Field Mappings**: SQL should reference mapped field names
5. **Required Fields**: SQL should include conditions to check for required fields
6. **Confidence Multipliers**: SQL should include confidence calculations

## Running Tests

To run the tests individually:

```bash
node scripts/run_tests.js --type integration --test multi_table_waterfall_basic_test
node scripts/run_tests.js --type integration --test multi_table_waterfall_field_mapping_test
node scripts/run_tests.js --type integration --test multi_table_waterfall_confidence_test
node scripts/run_tests.js --type integration --test multi_table_waterfall_required_fields_test
node scripts/run_tests.js --type integration --test multi_table_waterfall_large_scale_test
```

## Troubleshooting

If tests fail with "Cannot read properties of undefined" errors, check:

1. Parameter passing: Ensure parameters are correctly passed to the strategy
2. Class instantiation: Make sure to instantiate the `MatchStrategyFactory` class
3. Field format: Check that field mappings, required fields, and confidence multipliers have the correct format

When testing required fields or confidence multipliers, use flexible validation patterns as the exact implementation details (like SQL query structure) might change over time. 