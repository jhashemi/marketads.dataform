config {
  type: "assertion",
  description: "Validates phone number standardization across tables",
  tags: ["regression", "semantic_types", "phone"]
}

-- Import required modules
const semanticTypes = require("../../../includes/semantic_types");

-- Test various phone number formats to ensure proper standardization
WITH test_cases AS (
  SELECT '555-123-4567' as input, '+15551234567' as expected UNION ALL
  SELECT '(555) 123-4567' as input, '+15551234567' as expected UNION ALL
  SELECT '+1 555 123 4567' as input, '+15551234567' as expected UNION ALL
  SELECT '5551234567' as input, '+15551234567' as expected UNION ALL
  SELECT '555.123.4567' as input, '+15551234567' as expected UNION ALL
  SELECT '+44 20 1234 5678' as input, '+442012345678' as expected UNION ALL
  SELECT '+61 2 3456 7890' as input, '+61234567890' as expected UNION ALL
  SELECT '+33 1 23 45 67 89' as input, '+33123456789' as expected
),
standardized_results AS (
  SELECT 
    input,
    expected,
    ${semanticTypes.getStandardizationExpression("phone", "input")} as standardized
  FROM test_cases
)

-- Return any rows where standardization didn't produce expected results
SELECT 
  input, 
  expected, 
  standardized,
  'Phone standardization failed: expected "' || expected || '" but got "' || standardized || '"' as failure_message
FROM standardized_results
WHERE standardized != expected 